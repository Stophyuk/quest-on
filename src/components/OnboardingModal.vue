<template>
  <div class="fixed inset-0 z-50 bg-gradient-calm animate-fade-in overflow-hidden">
    <div class="h-full flex items-center justify-center p-4 overflow-y-auto">
      <div class="w-full max-w-md mx-auto">
        <!-- ë¸Œëœë“œ í—¤ë” - ê³ ì • ìœ„ì¹˜ -->
        <div class="text-center mb-12 pt-8">
          <h1 class="text-5xl font-bold font-pixel text-purple mb-2">
            Quest ON
          </h1>
          <p class="text-neutral-600 text-base font-gmarket font-light">ë‚´ì¼ì„ ONí•˜ëŠ” ì˜¤ëŠ˜ì˜ í€˜ìŠ¤íŠ¸</p>
        </div>

        <div class="animate-slide-up">

        <!-- ì§„í–‰ ë°” -->
        <div class="card p-6 mb-4">
          <div class="flex justify-between text-xs text-neutral-500 mb-2">
            <span>ë‹¨ê³„ {{ currentStep }}/{{ totalSteps }}</span>
            <span>{{ Math.round((currentStep / totalSteps) * 100) }}%</span>
          </div>
          <div class="w-full bg-neutral-200 rounded-full h-2">
            <div
              class="h-2 rounded-full transition-all duration-300"
              style="background: linear-gradient(to right, #8b5cf6, #3b82f6)"
              :style="{ width: `${(currentStep / totalSteps) * 100}%` }"
            ></div>
          </div>
        </div>

        <div class="card p-6">

        <!-- í™˜ì˜ ë‹¨ê³„ -->
        <div v-if="currentStep === 1" class="text-center space-y-4">
          <div class="text-6xl mb-4 animate-bounce">âš¡</div>
          <h2 class="text-2xl font-bold text-neutral-800">Quest ONì—<br>ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!</h2>
          <p class="text-neutral-600 font-gmarket">
            ìŠµê´€ì„ ê²Œì„ì²˜ëŸ¼ ì¬ë¯¸ìˆê²Œ!<br>
            ë§¤ì¼ ì‘ì€ ì„±ì·¨ë¡œ ì„±ì¥í•´ë³´ì„¸ìš”
          </p>
          <div class="pt-4">
            <button
              @click="nextStep"
              class="w-full py-3 px-4 text-white rounded-lg transition-all duration-200 font-medium shadow-md hover:opacity-90"
              style="background: linear-gradient(to right, #8b5cf6, #3b82f6)"
            >
              ì‹œì‘í•˜ê¸° âœ¨
            </button>
          </div>
        </div>

        <!-- í•µì‹¬ ê°€ì¹˜ ì„¤ëª… ë‹¨ê³„ -->
        <div v-if="currentStep === 2" class="text-center space-y-6">
          <div class="text-4xl mb-3">ğŸ¯</div>
          <h2 class="text-2xl font-bold text-neutral-800">Quest ONì€<br>íŠ¹ë³„í•´ìš”</h2>

          <!-- ìºë¦­í„° ì„±ì¥ ì‹œê°í™” -->
          <div class="flex items-center justify-center gap-4 py-4">
            <div class="text-center">
              <div class="text-4xl mb-1">ğŸ±</div>
              <p class="text-xs text-neutral-500">ë ˆë²¨ 1</p>
            </div>
            <div class="text-2xl text-purple-500">â†’</div>
            <div class="text-center">
              <div class="text-6xl mb-1">ğŸ±ğŸ˜Š</div>
              <p class="text-xs text-neutral-500">ë ˆë²¨ 5</p>
            </div>
            <div class="text-2xl text-purple-500">â†’</div>
            <div class="text-center">
              <div class="text-7xl mb-1">ğŸ±âœ¨</div>
              <p class="text-xs text-neutral-500">ë ˆë²¨ 8+</p>
            </div>
          </div>

          <div class="bg-purple-50 border-2 border-purple-200 rounded-xl p-4 text-left">
            <p class="text-neutral-700 font-gmarket leading-relaxed">
              í€˜ìŠ¤íŠ¸ë¥¼ ì™„ë£Œí• ìˆ˜ë¡<br>
              <span class="font-bold text-purple-600">ë‹¹ì‹ ì˜ ìºë¦­í„°ê°€ ì„±ì¥í•©ë‹ˆë‹¤</span><br><br>
              <span class="text-sm text-neutral-600">
              ì´ˆë°˜ì—ëŠ” ë¹ ë¥´ê²Œ ë ˆë²¨ì—…!<br>
              ì•½ 2-3ì¼ë§ˆë‹¤ ì„±ì¥í•˜ëŠ” ëª¨ìŠµì„ ë³¼ ìˆ˜ ìˆì–´ìš”
              </span>
            </p>
          </div>

          <p class="text-lg font-bold text-purple-600 font-gmarket">
            ìºë¦­í„°ì˜ ì„±ì¥ = ë‹¹ì‹ ì˜ ì„±ì¥ âœ¨
          </p>

          <div class="flex gap-3 pt-4">
            <button
              @click="prevStep"
              class="flex-1 py-2 px-4 border border-neutral-300 text-neutral-700 rounded-lg hover:bg-neutral-50 transition-colors"
            >
              ì´ì „
            </button>
            <button
              @click="nextStep"
              class="flex-1 py-2 px-4 text-white rounded-lg transition-all duration-200 hover:opacity-90"
              style="background: linear-gradient(to right, #8b5cf6, #3b82f6)"
            >
              ë‹¤ìŒ
            </button>
          </div>
        </div>

        <!-- ìºë¦­í„° ì„ íƒ ë‹¨ê³„ -->
        <div v-if="currentStep === 3" class="space-y-4">
          <div class="text-center">
            <h3 class="text-xl font-bold text-neutral-800 mb-2">ìºë¦­í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</h3>
            <p class="text-neutral-600 text-sm">í•¨ê»˜í•  í”½ì…€ ì¹œêµ¬ë¥¼ ê³¨ë¼ë³´ì„¸ìš”</p>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <button
              v-for="character in characters"
              :key="character.id"
              @click="selectCharacter(character.id)"
              :class="[
                'p-6 rounded-xl border-3 transition-all duration-200 text-center bg-white hover:scale-105',
                onboardingData.character === character.id
                  ? 'border-purple-500 bg-purple-50 shadow-lg'
                  : 'border-neutral-200 hover:border-neutral-300'
              ]"
            >
              <div class="text-6xl mb-2">{{ character.emoji }}</div>
              <div class="text-sm font-medium text-neutral-700">{{ character.name }}</div>
            </button>
          </div>

          <div class="flex gap-3 pt-4">
            <button
              @click="prevStep"
              class="flex-1 py-2 px-4 border border-neutral-300 text-neutral-700 rounded-lg hover:bg-neutral-50 transition-colors"
            >
              ì´ì „
            </button>
            <button
              @click="nextStep"
              :disabled="!onboardingData.character"
              class="flex-1 py-2 px-4 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 hover:opacity-90"
              style="background: linear-gradient(to right, #8b5cf6, #3b82f6)"
            >
              ë‹¤ìŒ
            </button>
          </div>
        </div>

        <!-- ë‹‰ë„¤ì„ ì„¤ì • ë‹¨ê³„ -->
        <div v-if="currentStep === 4" class="space-y-4">
          <div class="text-center">
            <div class="text-4xl mb-4">{{ getSelectedCharacter()?.emoji }}</div>
            <h3 class="text-xl font-bold text-neutral-800 mb-2">ì–´ë–»ê²Œ ë¶ˆëŸ¬ë“œë¦´ê¹Œìš”?</h3>
            <p class="text-neutral-600 text-sm">ì•ìœ¼ë¡œ ì‚¬ìš©í•  ë‹‰ë„¤ì„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”<br>
              <span class="text-xs text-neutral-500">í•œê¸€, ì˜ì–´, ìˆ«ìë§Œ ì‚¬ìš© ê°€ëŠ¥ (2-10ì)</span>
            </p>
          </div>

          <div>
            <input
              v-model="onboardingData.nickname"
              type="text"
              placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”"
              maxlength="10"
              class="w-full px-4 py-3 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-center text-lg"
              @keyup.enter="nextStep"
            >
            <p class="text-xs text-neutral-500 mt-1 text-center">
              {{ onboardingData.nickname.length }}/10
            </p>
          </div>

          <div class="flex gap-3 pt-4">
            <button
              @click="prevStep"
              class="flex-1 py-2 px-4 border border-neutral-300 text-neutral-700 rounded-lg hover:bg-neutral-50 transition-colors"
            >
              ì´ì „
            </button>
            <button
              @click="nextStep"
              :disabled="!isValidNickname()"
              class="flex-1 py-2 px-4 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 hover:opacity-90"
              style="background: linear-gradient(to right, #8b5cf6, #3b82f6)"
            >
              ë‹¤ìŒ
            </button>
          </div>
        </div>

        <!-- ê´€ì‹¬ ë¶„ì•¼ ì„ íƒ ë‹¨ê³„ -->
        <div v-if="currentStep === 5" class="space-y-4">
          <div class="text-center">
            <div class="text-4xl mb-4">ğŸ¯</div>
            <h3 class="text-xl font-bold text-neutral-800 mb-2">ê´€ì‹¬ ë¶„ì•¼ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</h3>
            <p class="text-neutral-600 text-sm">ê´€ì‹¬ ìˆëŠ” ë¶„ì•¼ë¥¼ ì„ íƒí•˜ë©´ ë§ì¶¤ í€˜ìŠ¤íŠ¸ë¥¼ ì¶”ì²œí•´ë“œë ¤ìš”</p>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <button
              v-for="category in categories"
              :key="category.value"
              @click="toggleCategory(category.value)"
              :class="[
                'p-4 rounded-lg border-2 transition-all duration-200 text-center',
                onboardingData.interests.includes(category.value)
                  ? 'border-purple bg-primary-100 text-purple font-semibold transform scale-105'
                  : 'border-neutral-200 hover:border-neutral-300 text-neutral-700 hover:bg-neutral-50'
              ]"
            >
              <div class="text-2xl mb-1">{{ category.emoji }}</div>
              <div class="text-sm font-medium">{{ category.label }}</div>
            </button>
          </div>

          <div class="flex gap-3 pt-4">
            <button
              @click="prevStep"
              class="flex-1 py-2 px-4 border border-neutral-300 text-neutral-700 rounded-lg hover:bg-neutral-50 transition-colors"
            >
              ì´ì „
            </button>
            <button
              @click="nextStep"
              :disabled="onboardingData.interests.length === 0"
              class="flex-1 py-2 px-4 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 hover:opacity-90"
              style="background: linear-gradient(to right, #8b5cf6, #3b82f6)"
            >
              ë‹¤ìŒ
            </button>
          </div>
        </div>

        <!-- ì™„ë£Œ ë‹¨ê³„ (ì˜¨ë³´ë”© í€˜ìŠ¤íŠ¸ ì™„ë£Œ) -->
        <div v-if="currentStep === 6" class="text-center space-y-4">
          <div class="text-6xl mb-4">ğŸ‰</div>
          <h3 class="text-2xl font-bold text-neutral-800 font-gmarket">ì˜¨ë³´ë”© ì™„ë£Œ!<br>í€˜ìŠ¤íŠ¸ ë‹¬ì„±</h3>
          <p class="text-neutral-600 font-gmarket">
            <span class="font-medium text-purple">{{ onboardingData.nickname }}</span>ë‹˜ì´<br>
            ì²« ë²ˆì§¸ í€˜ìŠ¤íŠ¸ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!
          </p>

          <!-- ì˜¨ë³´ë”© ì™„ë£Œ í€˜ìŠ¤íŠ¸ -->
          <div class="bg-primary-100 rounded-lg p-4 border-2 border-primary-200">
            <div class="text-center mb-3">
              <span class="text-5xl">ğŸ¯</span>
            </div>
            <h4 class="font-bold text-lg text-neutral-800 font-gmarket mb-2">ì˜¨ë³´ë”© ì™„ë£Œ í€˜ìŠ¤íŠ¸ ë‹¬ì„±</h4>
            <p class="text-sm text-neutral-600 mb-3">í”„ë¡œí•„ ì„¤ì • ë° ê´€ì‹¬ë¶„ì•¼ ì„ íƒ ì™„ë£Œ</p>

            <button
              @click="completeTutorialQuest"
              :disabled="tutorialQuestCompleted"
              :class="[
                'w-full py-2 px-3 rounded-lg font-medium transition-all duration-200',
                tutorialQuestCompleted
                  ? 'bg-green-100 text-green-700 cursor-not-allowed'
                  : 'bg-green-500 text-white hover:bg-green-600'
              ]"
            >
              {{ tutorialQuestCompleted ? 'ì™„ë£Œ! âœ…' : 'í™•ì¸' }}
            </button>
          </div>

          <div v-if="tutorialQuestCompleted" class="pt-4 space-y-3">
            <!-- ë ˆë²¨ì—… ì•Œë¦¼ -->
            <div class="bg-gold bg-opacity-20 border border-gold rounded-lg p-3 text-center">
              <div class="text-2xl mb-1">â­</div>
              <div class="font-semibold text-neutral-800 font-gmarket">ë ˆë²¨ ì—…!</div>
              <div class="text-sm text-neutral-600">
                <span class="text-lg font-bold text-primary">0</span> â†’
                <span class="text-lg font-bold text-success">1</span>
              </div>
            </div>

            <button
              @click="completeOnboarding"
              class="w-full py-3 px-4 text-white rounded-lg transition-all duration-200 font-medium shadow-md hover:opacity-90"
              style="background: linear-gradient(to right, #8b5cf6, #3b82f6)"
            >
              Quest ON ì‹œì‘í•˜ê¸°! ğŸš€
            </button>
          </div>
        </div>

        </div> <!-- card p-6 ë‹«ê¸° -->
        </div> <!-- animate-slide-up ë‹«ê¸° -->
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import { useQuestStore } from '../stores/quest.js'
import { usePersonalizationStore } from '../stores/personalization.js'

const emit = defineEmits(['complete'])

const questStore = useQuestStore()
const personalizationStore = usePersonalizationStore()

const currentStep = ref(1)
const totalSteps = 6
const tutorialQuestCompleted = ref(false)

const onboardingData = ref({
  character: '',
  nickname: '',
  interests: []
})

const characters = [
  { id: 'cat', name: 'ê³ ì–‘ì´', emoji: 'ğŸ±' },
  { id: 'dog', name: 'ê°•ì•„ì§€', emoji: 'ğŸ¶' },
  { id: 'pig', name: 'ë¼ì§€', emoji: 'ğŸ·' },
  { id: 'rabbit', name: 'í† ë¼', emoji: 'ğŸ°' }
]

const categories = [
  { value: 'health', label: 'ê±´ê°•', emoji: 'ğŸ’š' },
  { value: 'fitness', label: 'ìš´ë™', emoji: 'ğŸ’ª' },
  { value: 'learning', label: 'í•™ìŠµ', emoji: 'ğŸ“š' },
  { value: 'work', label: 'ì—…ë¬´', emoji: 'ğŸ’¼' },
  { value: 'hobby', label: 'ì·¨ë¯¸', emoji: 'ğŸ¨' },
  { value: 'mindfulness', label: 'ë§ˆìŒì±™ê¹€', emoji: 'ğŸ§˜' }
]

// ê´€ì‹¬ ë¶„ì•¼ë³„ ìƒ˜í”Œ í€˜ìŠ¤íŠ¸
const questTemplates = {
  health: [
    { title: 'ë¬¼ 8ì” ë§ˆì‹œê¸°', description: 'í•˜ë£¨ ê¶Œì¥ ìˆ˜ë¶„ ì„­ì·¨ëŸ‰', difficulty: { 'ğŸ˜Š': 8, 'ğŸ˜': 6, 'ğŸ˜': 4 } },
    { title: 'ë¹„íƒ€ë¯¼ ì±™ê²¨ë¨¹ê¸°', description: 'ê±´ê°•í•œ ì˜ì–‘ ë³´ì¶©', difficulty: { 'ğŸ˜Š': 1, 'ğŸ˜': 1, 'ğŸ˜': 1 } }
  ],
  fitness: [
    { title: '30ë¶„ ìš´ë™í•˜ê¸°', description: 'ì ë‹¹í•œ ê°•ë„ì˜ ìš´ë™', difficulty: { 'ğŸ˜Š': 30, 'ğŸ˜': 20, 'ğŸ˜': 10 } },
    { title: 'ë§Œë³´ ê±·ê¸°', description: 'í•˜ë£¨ 1ë§Œë³´ ëª©í‘œ', difficulty: { 'ğŸ˜Š': 10000, 'ğŸ˜': 7000, 'ğŸ˜': 5000 } }
  ],
  learning: [
    { title: 'ì±… ì½ê¸°', description: 'ë…ì„œë¡œ ì§€ì‹ ìŒ“ê¸°', difficulty: { 'ğŸ˜Š': 60, 'ğŸ˜': 30, 'ğŸ˜': 15 } },
    { title: 'ìƒˆë¡œìš´ ë‹¨ì–´ ì™¸ìš°ê¸°', description: 'ì–´íœ˜ë ¥ í–¥ìƒ', difficulty: { 'ğŸ˜Š': 10, 'ğŸ˜': 5, 'ğŸ˜': 3 } }
  ],
  work: [
    { title: 'íˆ¬ë‘ë¦¬ìŠ¤íŠ¸ ì™„ë£Œí•˜ê¸°', description: 'ì˜¤ëŠ˜ì˜ í•  ì¼ ì²´í¬', difficulty: { 'ğŸ˜Š': 5, 'ğŸ˜': 3, 'ğŸ˜': 2 } },
    { title: 'ì§‘ì¤‘ ì‹œê°„ ê°–ê¸°', description: 'ì§‘ì¤‘í•´ì„œ ì—…ë¬´í•˜ê¸°', difficulty: { 'ğŸ˜Š': 120, 'ğŸ˜': 90, 'ğŸ˜': 60 } }
  ],
  hobby: [
    { title: 'ì·¨ë¯¸ í™œë™í•˜ê¸°', description: 'ë‚˜ë§Œì˜ ì‹œê°„ ê°–ê¸°', difficulty: { 'ğŸ˜Š': 60, 'ğŸ˜': 30, 'ğŸ˜': 15 } },
    { title: 'ì°½ì‘ í™œë™í•˜ê¸°', description: 'ê·¸ë¦¼, ê¸€ì“°ê¸° ë“±', difficulty: { 'ğŸ˜Š': 30, 'ğŸ˜': 20, 'ğŸ˜': 10 } }
  ],
  mindfulness: [
    { title: 'ëª…ìƒí•˜ê¸°', description: 'ë§ˆìŒì˜ í‰ì˜¨ ì°¾ê¸°', difficulty: { 'ğŸ˜Š': 20, 'ğŸ˜': 15, 'ğŸ˜': 5 } },
    { title: 'ê°ì‚¬ ì¼ê¸° ì“°ê¸°', description: 'ê¸ì •ì  ë§ˆìŒê°€ì§', difficulty: { 'ğŸ˜Š': 1, 'ğŸ˜': 1, 'ğŸ˜': 1 } }
  ]
}

function selectCharacter(characterId) {
  onboardingData.value.character = characterId
}

function getSelectedCharacter() {
  return characters.find(c => c.id === onboardingData.value.character)
}

function completeTutorialQuest() {
  tutorialQuestCompleted.value = true
  // ì¶•í•˜ íš¨ê³¼ ì¶”ê°€ ê°€ëŠ¥
}

const sampleQuests = computed(() => {
  const quests = []
  let questId = Date.now()

  onboardingData.value.interests.forEach(interest => {
    if (questTemplates[interest]) {
      const template = questTemplates[interest][0]
      quests.push({
        id: questId++,
        ...template,
        category: interest,
        completed: false,
        progress: 0,
        createdAt: new Date().toISOString()
      })
    }
  })

  return quests
})

function toggleCategory(category) {
  const index = onboardingData.value.interests.indexOf(category)
  if (index > -1) {
    onboardingData.value.interests.splice(index, 1)
  } else {
    onboardingData.value.interests.push(category)
  }
}

function getCategoryEmoji(category) {
  const cat = categories.find(c => c.value === category)
  return cat ? cat.emoji : 'â­'
}

function nextStep() {
  if (currentStep.value < totalSteps) {
    currentStep.value++
  }
}

function prevStep() {
  if (currentStep.value > 1) {
    currentStep.value--
  }
}

function completeOnboarding() {
  // ì‚¬ìš©ì í”„ë¡œí•„ ì„¤ì •
  personalizationStore.userProfile.preferences.categories = onboardingData.value.interests
  personalizationStore.savePersonalizationData()

  // ì˜¨ë³´ë”© ì™„ë£Œë¡œ ë ˆë²¨ì—… (0 â†’ 1)
  questStore.gainExperience(100) // ì¶©ë¶„í•œ ê²½í—˜ì¹˜ë¥¼ ì¤˜ì„œ ë ˆë²¨ì—…

  // ìƒ˜í”Œ í€˜ìŠ¤íŠ¸ ì¶”ê°€
  sampleQuests.value.forEach(quest => {
    questStore.addQuest(quest)
  })

  // ì˜¨ë³´ë”© ì™„ë£Œ ìƒíƒœ localStorageì— ì €ì¥
  localStorage.setItem('quest-on-onboarding-completed', 'true')
  localStorage.setItem('quest-on-user-nickname', onboardingData.value.nickname)
  localStorage.setItem('quest-on-user-character', onboardingData.value.character)

  // ì˜¨ë³´ë”© ì™„ë£Œ ì´ë²¤íŠ¸ ë°œìƒ
  emit('complete', {
    character: onboardingData.value.character,
    nickname: onboardingData.value.nickname,
    interests: onboardingData.value.interests,
    questsAdded: sampleQuests.value.length
  })
}

// ë‹‰ë„¤ì„ ê²€ì¦ í•¨ìˆ˜
function validateNickname(nickname) {
  // í•œê¸€, ì˜ì–´, ìˆ«ìë§Œ í—ˆìš© (íŠ¹ìˆ˜ë¬¸ì ì œì™¸)
  const regex = /^[ê°€-í£a-zA-Z0-9]+$/
  return regex.test(nickname) && nickname.length >= 2 && nickname.length <= 10
}

function isValidNickname() {
  return onboardingData.value.nickname.trim() && validateNickname(onboardingData.value.nickname)
}

onMounted(() => {
  // ì˜ˆì‹œ ì œê±° - ë¹ˆ ìƒíƒœë¡œ ì‹œì‘
})
</script>

<style scoped>
@keyframes fade-in {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slide-up {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.animate-fade-in {
  animation: fade-in 0.3s ease-out;
}

.animate-slide-up {
  animation: slide-up 0.4s ease-out;
}
</style>